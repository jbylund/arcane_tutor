<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prefer Score Tuner</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 30px;
      }

      h1 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 2em;
      }

      .subtitle {
        color: #666;
        margin-bottom: 20px;
        font-size: 1.1em;
      }

      .controls-panel {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .controls-header h3 {
        color: #667eea;
        font-size: 1.3em;
      }

      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      .control-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
      }

      .control-value {
        color: #667eea;
        font-weight: bold;
      }

      input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #dee2e6;
        outline: none;
        -webkit-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
      }

      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        border: none;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2em;
      }

      .error {
        background: #ff6b6b;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .card-section {
        margin-bottom: 40px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        background: #f8f9fa;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
      }

      .card-name {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
      }

      .card-count {
        font-size: 1em;
        color: #6c757d;
        font-weight: 500;
      }

      .printings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 15px;
      }

      .printing {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .printing:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .printing-rank {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #667eea;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9em;
        z-index: 1;
      }

      .card-image {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .printing-set {
        font-size: 0.95em;
        color: #495057;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .printing-details {
        font-size: 0.85em;
        color: #6c757d;
        margin-bottom: 5px;
      }

      .printing-details strong {
        color: #495057;
      }

      .score-display {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
      }

      .score-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 8px;
      }

      .score-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .score-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .score-breakdown {
        font-size: 0.75em;
        color: #6c757d;
        line-height: 1.5;
      }

      .score-breakdown-item {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
      }

      .instructions {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .instructions h3 {
        color: #856404;
        margin-bottom: 10px;
      }

      .instructions p {
        color: #856404;
        line-height: 1.6;
        margin-bottom: 8px;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 1em;
        cursor: pointer;
        transition: background 0.2s;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      button:hover {
        background: #5568d3;
      }

      button:disabled {
        background: #adb5bd;
        cursor: not-allowed;
      }

      .buttons {
        margin-bottom: 15px;
      }

      .reset-button {
        background: #6c757d;
      }

      .reset-button:hover {
        background: #5a6268;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸŽ¯ Prefer Score Tuner</h1>
      <p class="subtitle">
        Adjust scoring parameters and see how different printings of iconic Magic cards are ranked
      </p>

      <div class="instructions">
        <h3>How it works</h3>
        <p>
          This tool fetches actual card printings from the Scryfall API and calculates scores client-side based on your adjustments.
          Use the sliders below to modify scoring weights and see the rankings update in real-time.
        </p>
        <p>
          <strong>Note:</strong> Artwork popularity scores use estimated printing counts since we fetch cards individually.
          The actual database implementation calculates exact counts across all printings by illustration_id.
        </p>
      </div>

      <div class="controls-panel">
        <div class="controls-header">
          <h3>Scoring Parameters</h3>
          <button class="reset-button" onclick="resetScoring()">Reset to Defaults</button>
        </div>
        <div class="controls-grid">
          <div class="control-group">
            <label>
              <span>Border - Black:</span>
              <span class="control-value" id="border-black-val">100</span>
            </label>
            <input type="range" id="border-black" min="0" max="200" value="100" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Border - White:</span>
              <span class="control-value" id="border-white-val">20</span>
            </label>
            <input type="range" id="border-white" min="0" max="100" value="20" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Frame - 2015:</span>
              <span class="control-value" id="frame-2015-val">100</span>
            </label>
            <input type="range" id="frame-2015" min="0" max="200" value="100" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Frame - 2003:</span>
              <span class="control-value" id="frame-2003-val">50</span>
            </label>
            <input type="range" id="frame-2003" min="0" max="150" value="50" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Common:</span>
              <span class="control-value" id="rarity-common-val">100</span>
            </label>
            <input type="range" id="rarity-common" min="0" max="200" value="100" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Uncommon:</span>
              <span class="control-value" id="rarity-uncommon-val">27</span>
            </label>
            <input type="range" id="rarity-uncommon" min="0" max="100" value="27" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Rare:</span>
              <span class="control-value" id="rarity-rare-val">8</span>
            </label>
            <input type="range" id="rarity-rare" min="0" max="50" value="8" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Mythic:</span>
              <span class="control-value" id="rarity-mythic-val">1</span>
            </label>
            <input type="range" id="rarity-mythic" min="0" max="25" value="1" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Extended Art:</span>
              <span class="control-value" id="extended-art-val">100</span>
            </label>
            <input type="range" id="extended-art" min="0" max="200" value="100" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Artwork Cap:</span>
              <span class="control-value" id="artwork-cap-val">40</span>
            </label>
            <input type="range" id="artwork-cap" min="10" max="100" value="40" oninput="updateScoring()" />
          </div>
        </div>
      </div>

      <div class="buttons">
        <button id="load-button" onclick="loadCards()">Load Card Printings</button>
      </div>

      <div id="loading" class="loading" style="display: none;">
        Loading card printings from database...
      </div>

      <div id="error" style="display: none;"></div>

      <div id="cards-container"></div>
    </div>

    <script>
      // Store all card data globally for re-scoring
      const cardData = {};

      // Iconic cards to showcase
      const iconicCards = [
        'Lightning Bolt',
        'Sol Ring',
        'Counterspell',
        'Path to Exile',
        'Llanowar Elves',
        'Dark Ritual',
      ];

      async function loadCards() {
        const loadButton = document.getElementById('load-button');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const container = document.getElementById('cards-container');

        loadButton.disabled = true;
        loading.style.display = 'block';
        errorDiv.style.display = 'none';
        container.innerHTML = '';

        try {
          for (const cardName of iconicCards) {
            await loadCardPrintings(cardName);
          }
        } catch (error) {
          errorDiv.innerHTML = `<div class="error">Error loading cards: ${error.message}</div>`;
          errorDiv.style.display = 'block';
          console.error('Error:', error);
        } finally {
          loading.style.display = 'none';
          loadButton.disabled = false;
        }
      }

      async function loadCardPrintings(cardName) {
        const container = document.getElementById('cards-container');
        
        // Use Scryfall API to get all printings with full data
        const query = encodeURIComponent(`name:"${cardName}"`);
        const url = `https://api.scryfall.com/cards/search?q=${query}&unique=prints`;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          
          if (!data.data || data.data.length === 0) {
            return;
          }

          // Store raw data for this card - Scryfall provides all needed fields
          cardData[cardName] = data.data.map(card => {
            // Extract frame effects to check for extended art
            const frameEffects = card.frame_effects || [];
            const hasExtendedArt = frameEffects.includes('extendedart');
            
            // Count printings by illustration_id (we'll use a placeholder for now)
            // In a real implementation, we'd need to count across all cards
            const printings = 20; // Placeholder - would need full dataset to calculate
            
            return {
              name: card.name,
              set_name: card.set_name,
              set: card.set,
              artist: card.artist,
              border_color: card.border_color,
              frame: card.frame,
              rarity: card.rarity,
              illustration_id: card.illustration_id,
              image_uris: card.image_uris,
              printings: printings,
              extendedArt: hasExtendedArt,
              collector_number: card.collector_number,
              released_at: card.released_at
            };
          });

          // Create section for this card
          renderCardSection(cardName);

        } catch (error) {
          console.error(`Error loading ${cardName}:`, error);
        }
      }

      function renderCardSection(cardName) {
        const container = document.getElementById('cards-container');
        const cards = cardData[cardName];
        
        if (!cards || cards.length === 0) return;

        // Calculate scores and sort
        const scoredCards = cards.map(card => ({
          ...card,
          ...calculateScore(card)
        })).sort((a, b) => b.score - a.score);

        // Create section
        const section = document.createElement('div');
        section.className = 'card-section';
        section.id = `section-${cardName.replace(/\s+/g, '-')}`;

        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `
          <div class="card-name">${cardName}</div>
          <div class="card-count">${scoredCards.length} printings</div>
        `;
        section.appendChild(header);

        // Create grid for printings
        const grid = document.createElement('div');
        grid.className = 'printings-grid';

        scoredCards.forEach((card, index) => {
          const printing = createPrintingCard(card, index + 1);
          grid.appendChild(printing);
        });

        section.appendChild(grid);
        container.appendChild(section);
      }

      function createPrintingCard(card, rank) {
        const div = document.createElement('div');
        div.className = 'printing';

        const setName = card.set_name || 'Unknown Set';
        const artist = card.artist || 'Unknown';
        
        // Use Scryfall's image_uris
        const imageUrl = card.image_uris && card.image_uris.normal 
          ? card.image_uris.normal
          : '';

        const maxScore = 500;
        const percentage = (card.score / maxScore) * 100;

        div.innerHTML = `
          <div class="printing-rank">#${rank}</div>
          ${imageUrl ? `<img src="${imageUrl}" class="card-image" alt="${card.name}" onerror="this.style.display='none'" />` : ''}
          <div class="printing-set">${setName} (${card.set.toUpperCase()})</div>
          <div class="printing-details"><strong>Artist:</strong> ${artist}</div>
          <div class="printing-details"><strong>Border:</strong> ${card.border_color}</div>
          <div class="printing-details"><strong>Frame:</strong> ${card.frame}</div>
          <div class="printing-details"><strong>Rarity:</strong> ${card.rarity}</div>
          <div class="printing-details"><strong>Released:</strong> ${card.released_at}</div>
          <div class="score-display">
            <div class="score-value">Score: ${card.score}</div>
            <div class="score-bar">
              <div class="score-fill" style="width: ${Math.min(100, percentage)}%"></div>
            </div>
            <div class="score-breakdown">
              <div class="score-breakdown-item">
                <span>Border:</span><span>${card.breakdown.border}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Frame:</span><span>${card.breakdown.frame}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Artwork:</span><span>${card.breakdown.artwork}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Rarity:</span><span>${card.breakdown.rarity}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Extended Art:</span><span>${card.breakdown.extendedArt}</span>
              </div>
            </div>
          </div>
        `;

        return div;
      }

      function calculateScore(card) {
        const params = getParams();
        const breakdown = {};
        let score = 0;

        // Border score (using border_color from Scryfall)
        const border = card.border_color || '';
        if (border === 'black') {
          breakdown.border = params.borderBlack;
          score += params.borderBlack;
        } else if (border === 'white' || border === 'borderless') {
          breakdown.border = params.borderWhite;
          score += params.borderWhite;
        } else {
          breakdown.border = 0;
        }

        // Frame score (using frame from Scryfall)
        if (card.frame === '2015') {
          breakdown.frame = params.frame2015;
          score += params.frame2015;
        } else if (card.frame === '2003') {
          breakdown.frame = params.frame2003;
          score += params.frame2003;
        } else if (card.frame === '1997') {
          breakdown.frame = 25;
          score += 25;
        } else if (card.frame === '1993') {
          breakdown.frame = 10;
          score += 10;
        } else {
          breakdown.frame = 0;
        }

        // Artwork score (logarithmic)
        if (card.printings > 1) {
          const artworkScore = Math.min(100, (Math.log(card.printings) / Math.log(params.artworkCap)) * 100);
          breakdown.artwork = Math.round(artworkScore);
          score += artworkScore;
        } else {
          breakdown.artwork = 0;
        }

        // Rarity score (using rarity from Scryfall)
        const rarityMap = {
          'common': params.rarityCommon,
          'uncommon': params.rarityUncommon,
          'rare': params.rarityRare,
          'mythic': params.rarityMythic
        };
        breakdown.rarity = rarityMap[card.rarity] || 0;
        score += breakdown.rarity;

        // Extended art (using extendedArt flag we set from frame_effects)
        if (card.extendedArt) {
          breakdown.extendedArt = params.extendedArt;
          score += params.extendedArt;
        } else {
          breakdown.extendedArt = 0;
        }

        return {
          score: Math.round(score),
          breakdown
        };
      }

      function getParams() {
        return {
          borderBlack: parseInt(document.getElementById('border-black').value),
          borderWhite: parseInt(document.getElementById('border-white').value),
          frame2015: parseInt(document.getElementById('frame-2015').value),
          frame2003: parseInt(document.getElementById('frame-2003').value),
          rarityCommon: parseInt(document.getElementById('rarity-common').value),
          rarityUncommon: parseInt(document.getElementById('rarity-uncommon').value),
          rarityRare: parseInt(document.getElementById('rarity-rare').value),
          rarityMythic: parseInt(document.getElementById('rarity-mythic').value),
          extendedArt: parseInt(document.getElementById('extended-art').value),
          artworkCap: parseInt(document.getElementById('artwork-cap').value)
        };
      }

      function updateScoring() {
        // Update displayed values
        document.getElementById('border-black-val').textContent = document.getElementById('border-black').value;
        document.getElementById('border-white-val').textContent = document.getElementById('border-white').value;
        document.getElementById('frame-2015-val').textContent = document.getElementById('frame-2015').value;
        document.getElementById('frame-2003-val').textContent = document.getElementById('frame-2003').value;
        document.getElementById('rarity-common-val').textContent = document.getElementById('rarity-common').value;
        document.getElementById('rarity-uncommon-val').textContent = document.getElementById('rarity-uncommon').value;
        document.getElementById('rarity-rare-val').textContent = document.getElementById('rarity-rare').value;
        document.getElementById('rarity-mythic-val').textContent = document.getElementById('rarity-mythic').value;
        document.getElementById('extended-art-val').textContent = document.getElementById('extended-art').value;
        document.getElementById('artwork-cap-val').textContent = document.getElementById('artwork-cap').value;

        // Re-render all card sections with new scoring
        for (const cardName in cardData) {
          const section = document.getElementById(`section-${cardName.replace(/\s+/g, '-')}`);
          if (section) {
            section.remove();
          }
          renderCardSection(cardName);
        }
      }

      function resetScoring() {
        document.getElementById('border-black').value = 100;
        document.getElementById('border-white').value = 20;
        document.getElementById('frame-2015').value = 100;
        document.getElementById('frame-2003').value = 50;
        document.getElementById('rarity-common').value = 100;
        document.getElementById('rarity-uncommon').value = 27;
        document.getElementById('rarity-rare').value = 8;
        document.getElementById('rarity-mythic').value = 1;
        document.getElementById('extended-art').value = 100;
        document.getElementById('artwork-cap').value = 40;
        updateScoring();
      }
    </script>
  </body>
</html>
