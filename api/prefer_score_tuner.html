<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prefer Score Tuner</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #333;
      }

      .container {
        max-width: 1800px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 30px;
      }

      h1 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 2em;
      }

      .subtitle {
        color: #666;
        margin-bottom: 20px;
        font-size: 1.1em;
      }

      .controls-panel {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .controls-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .controls-header h3 {
        color: #667eea;
        font-size: 1.3em;
      }

      .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }

      .control-group {
        display: flex;
        flex-direction: column;
      }

      .control-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
      }

      .control-value {
        color: #667eea;
        font-weight: bold;
      }

      input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #dee2e6;
        outline: none;
        -webkit-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
      }

      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
        border: none;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2em;
      }

      .error {
        background: #ff6b6b;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .card-section {
        margin-bottom: 40px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        background: #f8f9fa;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
      }

      .card-name {
        font-size: 1.5em;
        font-weight: bold;
        color: #667eea;
      }

      .card-count {
        font-size: 1em;
        color: #6c757d;
        font-weight: 500;
      }

      .printings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 12px;
      }

      .printing {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .printing:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .printing-rank {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #667eea;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9em;
        z-index: 1;
      }

      .card-image {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .printing-set {
        font-size: 0.85em;
        color: #495057;
        margin-bottom: 6px;
        font-weight: 600;
      }

      .printing-details {
        font-size: 0.75em;
        color: #6c757d;
        margin-bottom: 3px;
      }

      .printing-details strong {
        color: #495057;
      }

      .score-display {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #e9ecef;
      }

      .score-value {
        font-size: 1em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 8px;
      }

      .score-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .score-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .score-breakdown {
        font-size: 0.7em;
        color: #6c757d;
        line-height: 1.4;
      }

      .score-breakdown-item {
        display: flex;
        justify-content: space-between;
        padding: 1px 0;
      }

      .instructions {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .instructions h3 {
        color: #856404;
        margin-bottom: 10px;
      }

      .instructions p {
        color: #856404;
        line-height: 1.6;
        margin-bottom: 8px;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 1em;
        cursor: pointer;
        transition: background 0.2s;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      button:hover {
        background: #5568d3;
      }

      button:disabled {
        background: #adb5bd;
        cursor: not-allowed;
      }

      .buttons {
        margin-bottom: 15px;
      }

      .reset-button {
        background: #6c757d;
      }

      .reset-button:hover {
        background: #5a6268;
      }

      .card-input-section {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸŽ¯ Prefer Score Tuner</h1>
      <p class="subtitle">
        Adjust scoring parameters and see how different printings of iconic Magic cards are ranked
      </p>

      <div class="instructions">
        <h3>How it works</h3>
        <p>
          This tool fetches actual card printings from the Scryfall API and calculates scores client-side based on your adjustments.
          Use the sliders below to modify scoring weights and see the rankings update in real-time.
        </p>
        <p>
          <strong>Artwork scoring:</strong> Counts how many printings share the same illustration_id within the fetched results,
          then applies the formula: <code>multiplier * ln(count) / ln(40)</code> where multiplier is adjustable via slider.
        </p>
      </div>

      <div class="controls-panel">
        <div class="controls-header">
          <h3>Scoring Parameters</h3>
          <button class="reset-button" onclick="resetScoring()">Reset to Defaults</button>
        </div>
        <div class="controls-grid">
          <div class="control-group">
            <label>
              <span>Border - Black:</span>
              <span class="control-value" id="border-black-val">14</span>
            </label>
            <input type="range" id="border-black" min="0" max="200" value="14" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Border - White:</span>
              <span class="control-value" id="border-white-val">0</span>
            </label>
            <input type="range" id="border-white" min="0" max="100" value="0" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Frame - 2015:</span>
              <span class="control-value" id="frame-2015-val">42</span>
            </label>
            <input type="range" id="frame-2015" min="0" max="200" value="42" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Frame - 2003:</span>
              <span class="control-value" id="frame-2003-val">30</span>
            </label>
            <input type="range" id="frame-2003" min="0" max="150" value="30" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Common:</span>
              <span class="control-value" id="rarity-common-val">16</span>
            </label>
            <input type="range" id="rarity-common" min="0" max="200" value="16" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Uncommon:</span>
              <span class="control-value" id="rarity-uncommon-val">16</span>
            </label>
            <input type="range" id="rarity-uncommon" min="0" max="100" value="16" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Rare:</span>
              <span class="control-value" id="rarity-rare-val">0</span>
            </label>
            <input type="range" id="rarity-rare" min="0" max="50" value="0" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Rarity - Mythic:</span>
              <span class="control-value" id="rarity-mythic-val">0</span>
            </label>
            <input type="range" id="rarity-mythic" min="0" max="25" value="0" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Extended Art:</span>
              <span class="control-value" id="extended-art-val">12</span>
            </label>
            <input type="range" id="extended-art" min="0" max="200" value="12" oninput="updateScoring()" />
          </div>
          <div class="control-group">
            <label>
              <span>Artwork Multiplier:</span>
              <span class="control-value" id="artwork-cap-val">23</span>
            </label>
            <input type="range" id="artwork-cap" min="0" max="200" value="23" oninput="updateScoring()" />
          </div>
        </div>
      </div>

      <div class="card-input-section">
        <label for="card-name-input" style="font-weight: 600; margin-bottom: 8px; display: block;">Enter Card Name:</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input 
            type="text" 
            id="card-name-input" 
            placeholder="e.g., Lightning Bolt, Dark Ritual, Sol Ring..."
            style="flex: 1; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 1em;"
            onkeypress="if(event.key === 'Enter') loadCard()"
          />
          <button onclick="loadCard()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600;">
            Load Card
          </button>
        </div>
      </div>

      <div id="loading" class="loading" style="display: none;">
        Loading card printings from Scryfall...
      </div>

      <div id="error" style="display: none;"></div>

      <div id="cards-container"></div>
    </div>

    <script>
      // Store all card data globally for re-scoring
      const cardData = {};

      async function loadCard() {
        const input = document.getElementById('card-name-input');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const container = document.getElementById('cards-container');
        
        const cardName = input.value.trim();
        
        if (!cardName) {
          errorDiv.innerHTML = '<div class="error">Please enter a card name</div>';
          errorDiv.style.display = 'block';
          return;
        }

        loading.style.display = 'block';
        errorDiv.style.display = 'none';
        container.innerHTML = '';

        try {
          await loadCardPrintings(cardName);
        } catch (error) {
          errorDiv.innerHTML = `<div class="error">Error loading "${cardName}": ${error.message}</div>`;
          errorDiv.style.display = 'block';
          console.error('Error:', error);
        } finally {
          loading.style.display = 'none';
        }
      }

      async function loadCardPrintings(cardName) {
        const container = document.getElementById('cards-container');
        
        // Use Scryfall API to get all printings with full data
        const query = encodeURIComponent(`name:"${cardName}"`);
        const url = `https://api.scryfall.com/cards/search?q=${query}&unique=prints`;

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          
          if (!data.data || data.data.length === 0) {
            return;
          }

          // Count illustration_id occurrences across all cards
          const illustrationCounts = {};
          data.data.forEach(card => {
            if (card.illustration_id) {
              illustrationCounts[card.illustration_id] = (illustrationCounts[card.illustration_id] || 0) + 1;
            }
          });

          // Process and deduplicate cards
          const processedCards = data.data.map(card => {
            // Extract frame effects to check for extended art
            const frameEffects = card.frame_effects || [];
            const hasExtendedArt = frameEffects.includes('extendedart');
            
            // Get the count of printings with this illustration_id
            const printingsWithIllustration = card.illustration_id 
              ? illustrationCounts[card.illustration_id] 
              : 1;
            
            return {
              name: card.name,
              set_name: card.set_name,
              set: card.set,
              set_type: card.set_type || 'unknown',
              artist: card.artist,
              border_color: card.border_color,
              frame: card.frame,
              rarity: card.rarity,
              illustration_id: card.illustration_id,
              image_uris: card.image_uris,
              printings: printingsWithIllustration,
              extendedArt: hasExtendedArt,
              collector_number: card.collector_number,
              released_at: card.released_at
            };
          });

          // Deduplicate based on unique combination of (illustration, frame, border_color, rarity, extendedArt, set_type)
          const uniqueCards = new Map();
          processedCards.forEach(card => {
            const key = `${card.illustration_id || 'none'}-${card.frame}-${card.border_color}-${card.rarity}-${card.extendedArt}-${card.set_type}`;
            if (!uniqueCards.has(key)) {
              uniqueCards.set(key, card);
            }
          });

          // Store deduplicated cards
          cardData[cardName] = Array.from(uniqueCards.values());

          // Create section for this card
          renderCardSection(cardName);

        } catch (error) {
          console.error(`Error loading ${cardName}:`, error);
        }
      }

      function renderCardSection(cardName) {
        const container = document.getElementById('cards-container');
        const cards = cardData[cardName];
        
        if (!cards || cards.length === 0) return;

        // Calculate scores and sort
        const scoredCards = cards.map(card => ({
          ...card,
          ...calculateScore(card)
        })).sort((a, b) => b.score - a.score);

        // Create section
        const section = document.createElement('div');
        section.className = 'card-section';
        section.id = `section-${cardName.replace(/\s+/g, '-')}`;

        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `
          <div class="card-name">${cardName}</div>
          <div class="card-count">${scoredCards.length} printings</div>
        `;
        section.appendChild(header);

        // Create grid for printings
        const grid = document.createElement('div');
        grid.className = 'printings-grid';

        scoredCards.forEach((card, index) => {
          const printing = createPrintingCard(card, index + 1);
          grid.appendChild(printing);
        });

        section.appendChild(grid);
        container.appendChild(section);
      }

      function createPrintingCard(card, rank) {
        const div = document.createElement('div');
        div.className = 'printing';

        const setName = card.set_name || 'Unknown Set';
        const artist = card.artist || 'Unknown';
        
        // Use Scryfall's image_uris
        const imageUrl = card.image_uris && card.image_uris.normal 
          ? card.image_uris.normal
          : '';

        const maxScore = 500;
        const percentage = (card.score / maxScore) * 100;

        div.innerHTML = `
          <div class="printing-rank">#${rank}</div>
          ${imageUrl ? `<img src="${imageUrl}" class="card-image" alt="${card.name}" onerror="this.style.display='none'" />` : ''}
          <div class="printing-set">${setName} (${card.set.toUpperCase()})</div>
          <div class="printing-details"><strong>Type:</strong> ${card.set_type}</div>
          <div class="printing-details"><strong>Border:</strong> ${card.border_color} | <strong>Frame:</strong> ${card.frame}</div>
          <div class="printing-details"><strong>Rarity:</strong> ${card.rarity}${card.extendedArt ? ' | Extended Art' : ''}</div>
          <div class="score-display">
            <div class="score-value">Score: ${card.score}</div>
            <div class="score-bar">
              <div class="score-fill" style="width: ${Math.min(100, percentage)}%"></div>
            </div>
            <div class="score-breakdown">
              <div class="score-breakdown-item">
                <span>Border:</span><span>${card.breakdown.border}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Frame:</span><span>${card.breakdown.frame}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Artwork:</span><span>${card.breakdown.artwork}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Rarity:</span><span>${card.breakdown.rarity}</span>
              </div>
              <div class="score-breakdown-item">
                <span>Extended Art:</span><span>${card.breakdown.extendedArt}</span>
              </div>
            </div>
          </div>
        `;

        return div;
      }

      function calculateScore(card) {
        const params = getParams();
        const breakdown = {};
        let score = 0;

        // Border score (using border_color from Scryfall)
        const border = card.border_color || '';
        if (border === 'black') {
          breakdown.border = params.borderBlack;
          score += params.borderBlack;
        } else if (border === 'white' || border === 'borderless') {
          breakdown.border = params.borderWhite;
          score += params.borderWhite;
        } else {
          breakdown.border = 0;
        }

        // Frame score (using frame from Scryfall)
        if (card.frame === '2015') {
          breakdown.frame = params.frame2015;
          score += params.frame2015;
        } else if (card.frame === '2003') {
          breakdown.frame = params.frame2003;
          score += params.frame2003;
        } else if (card.frame === '1997') {
          breakdown.frame = 25;
          score += 25;
        } else if (card.frame === '1993') {
          breakdown.frame = 10;
          score += 10;
        } else {
          breakdown.frame = 0;
        }

        // Artwork score (logarithmic)
        // Formula: illustration_frequency_multiplier * ln(num_printings) / ln(40)
        if (card.printings > 1) {
          const artworkScore = params.artworkCap * (Math.log(card.printings) / Math.log(40));
          breakdown.artwork = Math.round(artworkScore);
          score += artworkScore;
        } else {
          breakdown.artwork = 0;
        }

        // Rarity score (using rarity from Scryfall)
        const rarityMap = {
          'common': params.rarityCommon,
          'uncommon': params.rarityUncommon,
          'rare': params.rarityRare,
          'mythic': params.rarityMythic
        };
        breakdown.rarity = rarityMap[card.rarity] || 0;
        score += breakdown.rarity;

        // Extended art (using extendedArt flag we set from frame_effects)
        if (card.extendedArt) {
          breakdown.extendedArt = params.extendedArt;
          score += params.extendedArt;
        } else {
          breakdown.extendedArt = 0;
        }

        return {
          score: Math.round(score),
          breakdown
        };
      }

      function getParams() {
        return {
          borderBlack: parseInt(document.getElementById('border-black').value),
          borderWhite: parseInt(document.getElementById('border-white').value),
          frame2015: parseInt(document.getElementById('frame-2015').value),
          frame2003: parseInt(document.getElementById('frame-2003').value),
          rarityCommon: parseInt(document.getElementById('rarity-common').value),
          rarityUncommon: parseInt(document.getElementById('rarity-uncommon').value),
          rarityRare: parseInt(document.getElementById('rarity-rare').value),
          rarityMythic: parseInt(document.getElementById('rarity-mythic').value),
          extendedArt: parseInt(document.getElementById('extended-art').value),
          artworkCap: parseInt(document.getElementById('artwork-cap').value)
        };
      }

      function updateScoring() {
        // Update displayed values
        document.getElementById('border-black-val').textContent = document.getElementById('border-black').value;
        document.getElementById('border-white-val').textContent = document.getElementById('border-white').value;
        document.getElementById('frame-2015-val').textContent = document.getElementById('frame-2015').value;
        document.getElementById('frame-2003-val').textContent = document.getElementById('frame-2003').value;
        document.getElementById('rarity-common-val').textContent = document.getElementById('rarity-common').value;
        document.getElementById('rarity-uncommon-val').textContent = document.getElementById('rarity-uncommon').value;
        document.getElementById('rarity-rare-val').textContent = document.getElementById('rarity-rare').value;
        document.getElementById('rarity-mythic-val').textContent = document.getElementById('rarity-mythic').value;
        document.getElementById('extended-art-val').textContent = document.getElementById('extended-art').value;
        document.getElementById('artwork-cap-val').textContent = document.getElementById('artwork-cap').value;

        // Re-render all card sections with new scoring
        for (const cardName in cardData) {
          const section = document.getElementById(`section-${cardName.replace(/\s+/g, '-')}`);
          if (section) {
            section.remove();
          }
          renderCardSection(cardName);
        }
      }

      function resetScoring() {
        document.getElementById('border-black').value = 14;
        document.getElementById('border-white').value = 0;
        document.getElementById('frame-2015').value = 42;
        document.getElementById('frame-2003').value = 30;
        document.getElementById('rarity-common').value = 16;
        document.getElementById('rarity-uncommon').value = 16;
        document.getElementById('rarity-rare').value = 0;
        document.getElementById('rarity-mythic').value = 0;
        document.getElementById('extended-art').value = 12;
        document.getElementById('artwork-cap').value = 23;
        updateScoring();
      }
    </script>
  </body>
</html>
