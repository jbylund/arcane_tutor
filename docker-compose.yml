services:
    postgres:
        cap_add:
        - ALL
        command:
        - /usr/local/bin/docker-entrypoint.sh
        - -c
        - config_file=/postgresql.conf
        container_name: scryfallpostgres
        environment:
        - PGDATA=/data/pg
        - POSTGRES_DB=${XPGDATABASE}
        - POSTGRES_PASSWORD=${XPGPASSWORD}
        - POSTGRES_USER=${XPGUSER}
        healthcheck:
            test: ["CMD-SHELL", "psql -U ${XPGUSER} -d ${XPGDATABASE} -c 'SELECT 1'"]
            interval: 100ms
            timeout: 1s
            retries: 5
            start_period: 30s
        image: registry.hub.docker.com/library/postgres:18
        ports:
        - 15432:5432
        shm_size: 1024M
        user: 1000:1000
        volumes:
        - ./configs/postgres/conf/pg_hba.conf:/pg_hba.conf
        - ./configs/postgres/conf/postgresql.conf:/postgresql.conf
        - ./configs/postgres/init/:/docker-entrypoint-initdb.d
        - /tmp/pgdata/:/data/pg
        - ./data/postgres/logs:/var/log/postgresql
    apiservice:
        build:
            context: ./
            dockerfile: ./api/Dockerfile
        cap_add:
        - ALL
        command:
        - dumb-init
        - --
        - python
        - -m
        - api.entrypoint
        container_name: apiservice
        depends_on:
            postgres:
                condition: service_healthy
        environment:
        - PGDATABASE=${XPGDATABASE}
        - PGHOST=${DOCKER_POSTGRES_HOST}
        - PGPASSWORD=${XPGPASSWORD}
        - PGUSER=${XPGUSER}
        - PYTHONUNBUFFERED=true
        external_links:
        - scryfallpostgres:${DOCKER_POSTGRES_HOST}
        ports:
        - 18080:8080
        user: 1000:1000
        volumes:
            - ./data/api:/data/api
    client:
        build:
            context: ./
            dockerfile: ./client/Dockerfile
        command:
        - dumb-init
        - --
        - python
        - -m
        - client.query_runner
        container_name: scryfallclient
        depends_on:
            apiservice:
                condition: service_started
        environment:
        - API_URL=http://apiservice:8080
        - QUERY_DELAY=1.0
        - BATCH_SIZE=50
        - PYTHONUNBUFFERED=true
        external_links:
        - apiservice:apiservice
        profiles:
        - client
        user: 1000:1000
