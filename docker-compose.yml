services:
    postgres:
        cap_add:
        - ALL
        command:
        - /usr/local/bin/docker-entrypoint.sh
        - -c
        - config_file=/postgresql.conf
        container_name: scryfallpostgres
        environment:
        - PGDATA=/data/pg
        - POSTGRES_DB=${XPGDATABASE}
        - POSTGRES_PASSWORD=${XPGPASSWORD}
        - POSTGRES_USER=${XPGUSER}
        healthcheck:
            test: ["CMD-SHELL", "psql -U ${XPGUSER} -d ${XPGDATABASE} -c 'SELECT 1'"]
            interval: 100ms
            timeout: 1s
            retries: 5
            start_period: 30s
        image: registry.hub.docker.com/library/postgres:18
        ports:
        - 15432:5432
        shm_size: 1024M
        user: 1000:1000
        volumes:
        - ./configs/postgres/conf/pg_hba.conf:/pg_hba.conf
        - ./configs/postgres/conf/postgresql.conf:/postgresql.conf
        - ./configs/postgres/init/:/docker-entrypoint-initdb.d
        - /tmp/pgdata/:/data/pg
        - ./data/postgres/logs:/var/log/postgresql
    apiservice:
        build:
            context: ./
            dockerfile: ./api/Dockerfile
        cap_add:
        - ALL
        command:
        - dumb-init
        - --
        - python
        - -m
        - scryfallos.api.entrypoint
        container_name: apiservice
        depends_on:
            postgres:
                condition: service_healthy
        environment:
        - PGDATABASE=${XPGDATABASE}
        - PGHOST=${DOCKER_POSTGRES_HOST}
        - PGPASSWORD=${XPGPASSWORD}
        - PGUSER=${XPGUSER}
        - PYTHONUNBUFFERED=true
        external_links:
        - scryfallpostgres:${DOCKER_POSTGRES_HOST}
        ports:
        - 18080:8080
        - 18081:8081
        user: 1000:1000
        volumes:
            - ./data/api:/data/api
    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        command:
        - --config.file=/etc/prometheus/prometheus.yml
        - --storage.tsdb.path=/prometheus
        - --web.console.libraries=/usr/share/prometheus/console_libraries
        - --web.console.templates=/usr/share/prometheus/consoles
        ports:
        - 19090:9090
        user: 1000:1000
        volumes:
        - ./configs/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
        - /tmp/prometheus_data:/prometheus
    
    grafana:
        image: grafana/grafana:latest
        container_name: grafana
        depends_on:
        - prometheus
        environment:
        - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
        - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
        - GF_USERS_ALLOW_SIGN_UP=false
        ports:
        - 13000:3000
        user: 1000:1000
        volumes:
        - /tmp/grafana_data:/var/lib/grafana
        - ./configs/grafana/provisioning:/etc/grafana/provisioning
