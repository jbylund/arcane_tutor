services:
    postgres:
        cap_add:
        - ALL
        command:
        - /usr/local/bin/docker-entrypoint.sh
        - -c
        - config_file=/postgresql.conf
        container_name: postgres
        environment:
        - PGDATA=/data/pg
        - POSTGRES_DB=${XPGDATABASE}
        - POSTGRES_PASSWORD=${XPGPASSWORD}
        - POSTGRES_USER=${XPGUSER}
        image: registry.hub.docker.com/library/postgres:17.5
        ports:
        - 15432:5432
        shm_size: 1024M
        user: 1000:1000
        volumes:
        - ./configs/postgres/conf/pg_hba.conf:/pg_hba.conf
        - ./configs/postgres/conf/postgresql.conf:/postgresql.conf
        - ./configs/postgres/init/:/docker-entrypoint-initdb.d
        - /tmp/pgdata:/data/pg
    apiservice:
        build:
            context: ./
            dockerfile: ./api/Dockerfile
        cap_add:
        - ALL
        command:
        - dumb-init
        - --
        - python
        - /scryfallos/api/entrypoint.py
        container_name: apiservice
        environment:
        - PGDATABASE=${XPGDATABASE}
        - PGHOST=${DOCKER_POSTGRES_HOST}
        - PGPASSWORD=${XPGPASSWORD}
        - PGUSER=${XPGUSER}
        - PYTHONUNBUFFERED=true
        external_links:
        - postgres:${DOCKER_POSTGRES_HOST}
        ports:
        - 18080:8080
        user: 1000:1000
        volumes:
            - ./data/api:/data/api
    clientservice:
        build:
            context: ./client/
            dockerfile: ./Dockerfile
        cap_add:
        - ALL
        command:
        - dumb-init
        - --
        - python
        - -u
        - ./entrypoint.py
        container_name: clientservice
        external_links:
        - apiservice
